
def reconcile_position(ymd):
    pptracker = uppt.PnLPosTracker(cc='HKG', country_issued_code='HK', save_dir='D:/Prod/CRB', loadsymap=False)
    my_sod = pptracker.get_sod_position(ymd)
    ishedge = pptracker.ishedge(my_sod.index.values)
    my_sod.loc[ishedge, 'shares'] = my_sod.loc[ishedge, 'shares'] / 50
    stk_sod = my_sod[(~ishedge) & (my_sod.index.values != 'cash')]

    # reconcile with position fetched from back office position management sysmtem

def check_pnl(st, en):
    pptracker = uppt.PnLPosTracker(cc='HKG', country_issued_code='HK', save_dir='D:/Prod/CRB', loadsymap=False)
    stats = pptracker.gen_all_stats(st, en)
    pptracker.change_currency(stats, fxrate=7.7501)
    return stats

def pre_open_run():
    pptracker = uppt.PnLPosTracker(cc='HKG', country_issued_code='HK', save_dir='D:/Prod/CRB', loadsymap=True)
    self = pptracker
    ymd = pd.Timestamp.today().strftime('%Y%m%d')
    prev_ymd = udt.getPrevTradingDay(ymd, cc='HKG')
    print(ymd)
    pptracker.gen_eod_trd_pos(prev_ymd)
    pptracker.gen_sod_position(ymd)

    reconcile_position(ymd)

    pnl = check_pnl('20200101', prev_ymd)

def fix_all_run():
    pptracker = uppt.PnLPosTracker(cc='HKG', country_issued_code='HK', save_dir='D:/Prod/CRB', loadsymap=True)
    self = pptracker
    ymds = [dt.strftime('%Y%m%d') for dt in udt.getTraingDays('20200101', '20201231', cc='HKG')]
    for i in range(1, len(ymds)):
        ymd = ymds[i]
        prev_ymd = ymds[i-1]
        print(ymd)
        pptracker.gen_eod_trd_pos(prev_ymd, clsprtype='local')
        pptracker.gen_sod_position(ymd, currency='local')
